name: SRA CI (Enterprise Managed)

on:
  pull_request:
  push:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # G-1: 시스템 고정 경로 (러너 PC 인프라) - 백슬래시 중복 및 따옴표 방지
  VENV_ROOT: 'C:\worksra\.venv'
  # G-2: 프로젝트 격리 절대 경로
  SRA_DATA_ROOT: 'C:\sra_data'
  # LLM 읽기 타임아웃
  SRA_LLM_READ_TIMEOUT: 600
  # 중앙 정책 저장소 접근용 토큰
  SRA_POLICY_TOKEN: ${{ secrets.SRA_POLICY_TOKEN }}
  # [버전 관리] 중앙 통제 로직이 포함된 최신 패치 버전
  SRA_REPO_URL: 'https://github.com/sungbae85/worksra.git'
  SRA_TAG: 'v0.5.6-20260110'

jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    defaults:
      run:
        shell: powershell

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Verify and Install SRA Engine
        run: |
          # 가상환경 내 Python 경로 동적 확보
          $PYTHON_EXE = Join-Path "${{ env.VENV_ROOT }}" "Scripts\python.exe"
          
          # [해결] 만약 가상환경이 깨졌다면(No Python 에러 방지) 시스템 파서로 재지정 시도
          if (!(Test-Path $PYTHON_EXE)) {
              Write-Error "Virtual Environment not found at ${{ env.VENV_ROOT }}. Please check runner setup."
              exit 1
          }

          $TRUSTED = @("--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org", "--trusted-host", "github.com")
          Write-Host "Syncing SRA Engine to Version: ${{ env.SRA_TAG }}..."
          
          # 가상환경 파이썬으로 직접 실행 (따옴표 이슈 해결)
          & $PYTHON_EXE -m pip install $TRUSTED --upgrade pip setuptools wheel
          & $PYTHON_EXE -m pip install $TRUSTED --force-reinstall "${{ env.SRA_REPO_URL }}@${{ env.SRA_TAG }}"

      - name: 3. Set Run ID
        run: |
          $RID = "${{ github.run_id }}-${{ github.run_attempt }}"
          echo "SRA_RUN_ID=$RID" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Assigned Run ID: $RID"

      - name: 4. Run SRA Scan (Centralized Policy Mode)
        env:
          SRA_POLICY_TOKEN: ${{ env.SRA_POLICY_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          $PYTHON_EXE = Join-Path "${{ env.VENV_ROOT }}" "Scripts\python.exe"
          # Scan 실행 (LLM 연동을 위해 환경 변수 자동 반영됨)
          & $PYTHON_EXE -m sra scan `
            --repo . `
            --user "${{ github.actor }}" `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --run-id "$env:SRA_RUN_ID" `
            --use-llm off

      - name: 5. Run SRA Gate (Quality Check)
        if: always()
        run: |
          $PYTHON_EXE = Join-Path "${{ env.VENV_ROOT }}" "Scripts\python.exe"
          & $PYTHON_EXE -m sra gate `
            --repo . `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --run-id "$env:SRA_RUN_ID"

      - name: 6. Slack Notification
        if: always()
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          $PYTHON_EXE = Join-Path "${{ env.VENV_ROOT }}" "Scripts\python.exe"
          & $PYTHON_EXE -m sra notify `
            --run-id "$env:SRA_RUN_ID" `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --webhook-url "${{ env.SLACK_URL }}" `
            --user "${{ github.actor }}"

      - name: 7. Cleanup Old Reports
        if: always()
        run: |
          $limit = (Get-Date).AddDays(-2)
          # [수정] 프로젝트명을 동적으로 가져와 특정 프로젝트 데이터만 안전하게 청소
          $projectName = "${{ github.event.repository.name }}"
          $targetPath = Join-Path "${{ env.SRA_DATA_ROOT }}" $projectName
          
          if (Test-Path $targetPath) {
              Get-ChildItem -Path $targetPath -Directory | Where-Object { $_.CreationTime -lt $limit } | ForEach-Object {
                  Remove-Item -Path $_.FullName -Recurse -Force
                  Write-Host "Removed old report: $($_.Name)"
              }
          }