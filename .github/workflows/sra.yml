name: SRA Scan (Stable Windows)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      use_llm:
        description: "Use LLM (on/off)"
        required: false
        default: "off"

permissions:
  contents: read
  pull-requests: write


jobs:
  scan:
    runs-on: [self-hosted, windows]


    env:
      #  로컬 정책 SSOT
      SRA_POLICY_SOURCE: local
      SRA_POLICIES_DIR: C:\sra-policies

      #  오프라인 wheel 경로(레포 안)
      WHEEL_DIR: vendor/wheels

      # (선택) worksra 레이아웃을 쓰면
      SRA_HOME: C:\worksra

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # self-hosted라면 setup-python이 항상 필요하진 않지만,
      # 혹시 runner에 python이 없거나 PATH가 꼬였을 때 대비해 둡니다.
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Sanity check Python
        shell: pwsh
        run: |
          Write-Host "python location:"
          where python
          python --version


      - name: Verify local policy files exist
        shell: pwsh
        run: |
          if (!(Test-Path "$env:SRA_POLICIES_DIR\inventory.yml")) {
            Write-Error "Missing inventory.yml in $env:SRA_POLICIES_DIR"
            exit 1
          }
          if (!(Test-Path "$env:SRA_POLICIES_DIR\global_default.yml")) {
            Write-Error "Missing global_default.yml in $env:SRA_POLICIES_DIR"
            exit 1
          }

      - name: Create venv
        shell: pwsh
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install -U pip
          .\.venv\Scripts\python -m pip --version

      - name: Install SRA (offline wheel, pinned)
        shell: pwsh
        run: |
          if (!(Test-Path "$env:WHEEL_DIR")) {
            Write-Error "Missing wheel dir: $env:WHEEL_DIR"
            exit 1
          }

          # 권장: vendor/requirements-sra.txt에 정확한 버전 pin
          if (Test-Path "vendor/requirements-sra.txt") {
            .\.venv\Scripts\python -m pip install --no-index --find-links "$env:WHEEL_DIR" -r vendor/requirements-sra.txt
          } else {
            # requirements 파일이 없다면 최소한 sra 패키지를 wheel에서 찾도록 시도
            .\.venv\Scripts\python -m pip install --no-index --find-links "$env:WHEEL_DIR" sra
          }


          .\.venv\Scripts\python -c "import sra; print('SRA import OK')"

      - name: Run SRA (PR LLM OFF)
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          .\.venv\Scripts\python -m sra scan --repo . --use-llm off

      - name: Run SRA (Manual)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $use_llm = "${{ inputs.use_llm }}"
          if ([string]::IsNullOrWhiteSpace($use_llm)) { $use_llm = "off" }
          .\.venv\Scripts\python -m sra scan --repo . --use-llm $use_llm

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: sra-reports
          path: reports/**
          if-no-files-found: warn


