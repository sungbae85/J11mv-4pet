name: SRA Scan (Offline Wheel)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      use_llm:
        description: "Use LLM (on/off)"
        required: false
        default: "off"
      context_mode:
        description: "Context mode (pr_diff/full)"
        required: false
        default: "pr_diff"

permissions:
  contents: read
  pull-requests: write

jobs:
  scan:
    runs-on: [self-hosted, windows]

    env:
      # ✅ 로컬 정책 SSOT
      SRA_POLICY_SOURCE: local
      SRA_POLICIES_DIR: C:\sra-policies

      # (선택) tools/bundle 레이아웃 루트가 worksra면
      SRA_HOME: C:\worksra

      # wheel 경로(레포 안)
      WHEEL_DIR: vendor/wheels

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify local policies exist
        shell: pwsh
        run: |
          if (!(Test-Path "$env:SRA_POLICIES_DIR\inventory.yml")) {
            Write-Error "Missing inventory.yml in $env:SRA_POLICIES_DIR"
            exit 1
          }

          if (!(Test-Path "$env:SRA_POLICIES_DIR\global_default.yml")) {
            Write-Error "Missing global_default.yml in $env:SRA_POLICIES_DIR"
            exit 1
          }


      - name: Create venv
        shell: pwsh
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install -U pip

      - name: Install SRA (offline wheel, pinned)
        shell: pwsh
        run: |
          # ✅ 권장: requirements에 정확한 버전 명시
          #   예) vendor/requirements-sra.txt에 "sra==0.5.6.post20260110"
          #  없으면, wheel dir에서 설치 가능한 패키지 설치
          if (Test-Path "vendor/requirements-sra.txt") {
            .\.venv\Scripts\python -m pip install --no-index --find-links "$env:WHEEL_DIR" -r vendor/requirements-sra.txt
          } else {
            # wheel 파일이 1개라고 가정(또는 sra/worksra wheel이 포함)
            .\.venv\Scripts\python -m pip install --no-index --find-links "$env:WHEEL_DIR" sra
          }

          .\.venv\Scripts\python -c "import sra; print('SRA import OK')"

      - name: "Run SRA (PR: LLM OFF)"
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          .\.venv\Scripts\python -m sra scan --repo . --use-llm off

      - name: Run SRA (Manual)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $use_llm = "${{ inputs.use_llm }}"
          if ([string]::IsNullOrWhiteSpace($use_llm)) { $use_llm = "off" }
          .\.venv\Scripts\python -m sra scan --repo . --use-llm $use_llm

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: sra-reports
          path: reports/**
          if-no-files-found: warn
